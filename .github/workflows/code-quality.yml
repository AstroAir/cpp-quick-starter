name: Code Quality

'on':
  push:
    branches:
      - master
  pull_request:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ==========================================================================
  # Pre-commit Hooks
  # ==========================================================================
  pre-commit:
    name: Pre-commit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup uv
        uses: astral-sh/setup-uv@v3

      - name: Install dev dependencies
        run: uv sync --group dev

      - name: Install system tools
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-format clang-tidy ninja-build

      - name: Run pre-commit on all files
        run: uv run pre-commit run --all-files

  # ==========================================================================
  # Clang-Format Check
  # ==========================================================================
  clang-format:
    name: Clang-Format
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install clang-format
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-format

      - name: Check C++ formatting
        shell: bash
        run: |
          echo "Checking formatting for C++ files..."
          files=$(find src include tests benchmarks examples -name "*.cpp" -o -name "*.hpp" 2>/dev/null || true)
          if [[ -n "$files" ]]; then
            echo "$files" | xargs clang-format --dry-run --Werror
            echo "âœ… All files are properly formatted"
          else
            echo "No C++ files found to check"
          fi

  # ==========================================================================
  # Clang-Tidy Static Analysis
  # ==========================================================================
  clang-tidy:
    name: Clang-Tidy
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y clang clang-tidy ninja-build

      - name: Configure (generate compile_commands.json)
        run: cmake --preset ninja-debug

      - name: Run clang-tidy
        shell: bash
        run: |
          echo "Running clang-tidy analysis..."
          find src -name "*.cpp" | xargs clang-tidy -p build --warnings-as-errors='*'

  # ==========================================================================
  # Cppcheck Static Analysis
  # ==========================================================================
  cppcheck:
    name: Cppcheck
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install cppcheck
        run: |
          sudo apt-get update
          sudo apt-get install -y cppcheck

      - name: Run cppcheck
        run: |
          cppcheck --enable=warning,style,performance,portability \
            --error-exitcode=1 \
            --suppress=missingIncludeSystem \
            --inline-suppr \
            -I include \
            src/ tests/ examples/

  # ==========================================================================
  # Include-What-You-Use (IWYU)
  # ==========================================================================
  iwyu:
    name: Include-What-You-Use
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y iwyu ninja-build

      - name: Configure
        run: cmake --preset ninja-debug

      - name: Run IWYU
        run: |
          iwyu_tool.py -p build -- -Xiwyu --no_fwd_decls || true
          echo "IWYU analysis complete (informational only)"

  # ==========================================================================
  # EditorConfig Check
  # ==========================================================================
  editorconfig:
    name: EditorConfig
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install editorconfig-checker
        run: |
          curl -sSL https://github.com/editorconfig-checker/editorconfig-checker/releases/download/2.8.0/ec-linux-amd64.tar.gz | tar xz
          sudo mv bin/ec-linux-amd64 /usr/local/bin/ec

      - name: Check EditorConfig compliance
        run: ec --exclude "build|\.git|\.venv|uv\.lock"

  # ==========================================================================
  # Markdown Lint
  # ==========================================================================
  markdown:
    name: Markdown Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Lint Markdown files
        uses: DavidAnson/markdownlint-cli2-action@v19
        with:
          globs: |
            **/*.md
            !build/**
            !.venv/**

  # ==========================================================================
  # YAML Lint
  # ==========================================================================
  yaml:
    name: YAML Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Lint YAML files
        uses: ibiqlik/action-yamllint@v3
        with:
          file_or_dir: .
          config_data: |
            extends: default
            rules:
              line-length:
                max: 120
              truthy:
                check-keys: false

  # ==========================================================================
  # CMake Lint
  # ==========================================================================
  cmake-lint:
    name: CMake Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install cmake-lint
        run: pip install cmakelint

      - name: Lint CMakeLists.txt
        run: |
          find . -name "CMakeLists.txt" -not -path "./build/*" | xargs cmakelint --filter=-linelength || true

  # ==========================================================================
  # Security Scan (CodeQL)
  # ==========================================================================
  codeql:
    name: CodeQL Security Scan
    runs-on: ubuntu-latest
    permissions:
      security-events: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: cpp

      - name: Install Ninja
        run: sudo apt-get update && sudo apt-get install -y ninja-build

      - name: Build for CodeQL
        run: |
          cmake --preset ninja-ci
          cmake --build --preset ninja-ci

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
